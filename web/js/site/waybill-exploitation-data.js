
$(document).ready(function() {

    // прохожусь по каждой строчке таблицы и устанавливаю фиксированным колонкам ширину соответствующую не фиксированным строкам
    var num = 1;
    $('#exploitation-data-table tr').each(function() {
        var $tr = $(this);
        if(num == 1) {
            var height = $tr.find('th').eq(8).css('height');

            height = parseInt(height) + 2 + 'px';
            //console.log('num='+num + ' height='+height);
            $tr.find('th').eq(0).css('height', height);
            $tr.find('th').eq(1).css('height', height);
            $tr.find('th').eq(2).css('height', height);
            $tr.find('th').eq(3).css('height', height);
            $tr.find('th').eq(4).css('height', height);
            $tr.find('th').eq(5).css('height', height);

        }else {
            var height = $tr.find('td').eq(8).css('height');

            if(num == 2) {
                height = parseInt(height) + 1 + 'px';
            }

            //console.log('num='+num + ' height='+height);
            $tr.find('td').eq(0).css('height', height);
            $tr.find('td').eq(1).css('height', height);
            $tr.find('td').eq(2).css('height', height);
            $tr.find('td').eq(3).css('height', height);
            $tr.find('td').eq(4).css('height', height);
            $tr.find('td').eq(5).css('height', height);
        }

        num++;

    });
});


function updateExploitationField($obj) {

    var waybill_id = $obj.attr('waybill-id');
    var field_name = $obj.attr('field')
    var field_value = $obj.val();

    $.ajax({
        url: '/waybill/transport-waybill/ajax-update-waybill-field?waybill_id=' + waybill_id + '&field_name=' + field_name + '&field_value=' + field_value,
        type: 'post',
        data: {},
        success: function (response) {

            if(response.success == true) {
                location.reload();
            }else {
                alert('Неизвестная ошибка');
            }
        },
        error: function (data, textStatus, jqXHR) {
            if (textStatus == 'error' && data != undefined) {
                if (void 0 !== data.responseJSON) {
                    if (data.responseJSON.message.length > 0) {
                        alert(data.responseJSON.message);
                    }
                } else {
                    if (data.responseText.length > 0) {
                        alert(data.responseText);
                    }
                }
            }else {
                //handlingAjaxError(data, textStatus, jqXHR);
            }
        }
    });
}

//$(document).on('change', '*[field="accruals_to_issue_for_trip"]', function() {
//    updateExploitationField($(this));
//});

// сохранение изменений в таблице нажатием на кнопку "Сохранить изменения"
$(document).on('click', '#save-exploitation-table', function() {

    // по всем открытым строкам по полю "Оплата" собираем данные
    var form_data = [];
    $('#exploitation-data-table tbody').find('tr').each(function() {
        var id = $(this).attr('data-key');
        var value = $(this).find('input[name="TransportWaybill[accruals_to_issue_for_trip]"]').val();

        //console.log('id=' + id + ' value='+value);
        form_data.push({
           id: id,
           accruals_to_issue_for_trip: value
        });
    });

    //console.log(form_data);

    $.ajax({
        url: '/waybill/transport-waybill/ajax-update-waybill-fields',
        type: 'post',
        data: {
            form_data: form_data
        },
        success: function (response) {

            if(response.success == true) {
                location.reload();
            }else {
                alert('Неизвестная ошибка');
            }
        },
        error: function (data, textStatus, jqXHR) {
            if (textStatus == 'error' && data != undefined) {
                if (void 0 !== data.responseJSON) {
                    if (data.responseJSON.message.length > 0) {
                        alert(data.responseJSON.message);
                    }
                } else {
                    if (data.responseText.length > 0) {
                        alert(data.responseText);
                    }
                }
            }else {
                //handlingAjaxError(data, textStatus, jqXHR);
            }
        }
    });

    return false;
});